name: performance-pr

on:
  pull_request:
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: tier1_nano
            pattern: ".*(raw|basicModel|keyMatchModel).*"
            duration: "100ms"
            exclude: ""
            heap: "2G"
          - name: tier2_micro
            pattern: ".*(roleManagerSmall|rbacModelWithResourceRoles|rbacModelWithDomains).*"
            duration: "200ms"
            exclude: ""
            heap: "2G"
          - name: tier3_milli
            pattern: ".*(rbacModelSmall|rbacModelMedium|roleManagerMedium|abacModel|rbacModelWithDeny|rbacModelSizes).*"
            duration: "300ms"
            exclude: ".*Parallel.*"
            heap: "2G"
          - name: tier4_write
            pattern: ".*(ManagementApiBenchmark|priorityModel).*"
            duration: "400ms"
            exclude: ""
            heap: "2G"
          - name: tier5_parallel
            pattern: ".*(concurrentHasLinkWithMatching).*"
            duration: "600ms"
            exclude: ""
            heap: "4G"
          - name: tier6_heavy
            pattern: ".*(roleManagerLarge|rbacModelLarge|buildRoleLinks.*Large|hasLinkWith.*Large|Parallel).*"
            duration: "800ms"
            exclude: ""
            heap: "4G"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "8"
          cache: maven

      - name: Calculate SHAs
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
            echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          else
            echo "HEAD_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
            git fetch -q origin master
            echo "BASE_SHA=$(git merge-base "${GITHUB_SHA}" "origin/master")" >> $GITHUB_ENV
          fi

      - name: Run Benchmarks (${{ matrix.name }})
        shell: bash
        run: |
          set -euo pipefail
          
          # JVM Tuning
          JVM_ARGS="-Xms${{ matrix.heap }} -Xmx${{ matrix.heap }} -XX:+AlwaysPreTouch -XX:+UseParallelGC"
          
          run_bench_cycle() {
            local sha="$1"
            local type="$2" # "base" or "pr"
            
            echo "::group::Running $type on $sha (${{ matrix.name }})"
            git checkout -f "$sha"
            git clean -fdx -e "*.json" -e ".github"
            
            # Inject dependencies (JMH)
            if ! grep -q "jmh-core" pom.xml; then
              sed -i 's|</dependencies>|    <dependency><groupId>org.openjdk.jmh</groupId><artifactId>jmh-core</artifactId><version>1.37</version><scope>test</scope></dependency>\n        <dependency><groupId>org.openjdk.jmh</groupId><artifactId>jmh-generator-annprocess</artifactId><version>1.37</version><scope>test</scope></dependency>\n    </dependencies>|' pom.xml
            fi
            
            mvn -q clean test-compile dependency:build-classpath -DincludeScope=test -Dmdep.outputFile=cp.txt
            CP_ARGS="-cp target/test-classes:target/classes:$(cat cp.txt)"
            
            # Helper to run a tier
            run_tier() {
                local pattern="$1"
                local duration="$2"
                local exclude="$3"
                
                # Minimum duration 100ms
                if [[ "$duration" == "50ms" ]]; then duration="100ms"; fi
                
                echo "--> Running ${{ matrix.name }} ($duration)..."
                
                local exclude_arg=""
                if [ -n "$exclude" ]; then
                    exclude_arg="-e $exclude"
                fi
                
                # Output file: e.g., base-tier1_nano.json
                local out_file="${type}-${{ matrix.name }}.json"
                
                java $JVM_ARGS $CP_ARGS org.openjdk.jmh.Main \
                    -wi 3 -i 5 -f 2 \
                    -w $duration -r $duration \
                    -prof gc \
                    -rf json -rff "$out_file" \
                    $exclude_arg \
                    "$pattern" || true
                    
                # Ensure file exists
                if [ ! -f "$out_file" ]; then echo "[]" > "$out_file"; fi
            }
            
            run_tier "${{ matrix.pattern }}" "${{ matrix.duration }}" "${{ matrix.exclude }}"
            
            echo "::endgroup::"
          }
          
          run_bench_cycle "$BASE_SHA" "base"
          run_bench_cycle "$HEAD_SHA" "pr"
          
          # Move to subfolder for upload
          mkdir -p jcasbin
          mv *-*.json jcasbin/

      - name: Upload Shard Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-shard-${{ matrix.name }}
          path: jcasbin/*.json

  report:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-shard-*
          merge-multiple: true
          path: benchmark_data/jcasbin

      - name: Merge Results
        run: |
          # Merge all base-tier*.json into base.json
          python .github/scripts/merge_benchmarks.py base.json benchmark_data/jcasbin/base-*.json
          # Merge all pr-tier*.json into pr.json
          python .github/scripts/merge_benchmarks.py pr.json benchmark_data/jcasbin/pr-*.json

      - name: Save commit info
        id: commits
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "base_short=${BASE_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "head_short=${HEAD_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Compare benchmarks
        run: |
          cat > comparison.md << 'EOF'
          ## Benchmark Comparison
          
          Comparing base branch (`${{ steps.commits.outputs.base_short }}`)
          vs PR branch (`${{ steps.commits.outputs.head_short }}`)
          
          ```
          EOF
          
          python .github/scripts/pytest_benchstat.py base.json pr.json >> comparison.md || true
          echo '```' >> comparison.md
          
          # Post-process
          python .github/scripts/benchmark_formatter.py

      - name: Save PR number
        run: |
          echo "${{ github.event.pull_request.number }}" > pr_number.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            comparison.md
            pr_number.txt
